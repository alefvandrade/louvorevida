<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Editar Perfil - Louvor e Vida</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    main { max-width: 600px; margin: 50px auto; padding: 30px; background: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1 { margin-bottom: 30px; text-align: center; }
  </style>
</head>
<body>
  <!-- Header dinâmico -->
  <div id="header"></div>

  <main>
    <h1>Editar Perfil</h1>
    <form id="formEditarAdmin">
      <div class="mb-3">
        <label for="usuarioAtual" class="form-label">Usuário Atual</label>
        <input type="text" class="form-control" id="usuarioAtual" required>
      </div>
      <div class="mb-3">
        <label for="senhaAtual" class="form-label">Senha Atual</label>
        <input type="password" class="form-control" id="senhaAtual" required>
      </div>
      <div class="mb-3">
        <label for="novaSenha" class="form-label">Nova Senha</label>
        <input type="password" class="form-control" id="novaSenha">
      </div>
      <div class="mb-3">
        <label for="confirmarSenha" class="form-label">Confirmar Nova Senha</label>
        <input type="password" class="form-control" id="confirmarSenha">
      </div>
      <button type="submit" class="btn btn-primary w-100">Salvar Alterações</button>
    </form>
    <div id="mensagem" class="mt-3"></div>
  </main>

  <!-- Footer dinâmico -->
  <div id="footer"></div>

  <!-- JS embutido -->
  <script type="module">
    import Admin from './Admin.js';
    import Conexao from './Conexao.js';

    class EditarAdmin extends Admin {
      constructor() {
        super();
        this.adminAtual = null;
      }

      async init() {
        await super.init();
        await this.carregarAdmin();
      }

      async carregarAdmin() {
        const [rows] = await this.conexao.execute(`SELECT * FROM ${this.tabela} LIMIT 1`);
        if (rows.length === 0) throw new Error("Nenhum admin encontrado");
        this.adminAtual = rows[0];
        return this.adminAtual;
      }

      async validarSenhaAtual(senha) {
        // Confere se a senha atual digitada bate com a do banco
        return await import('bcrypt').then(bcrypt => bcrypt.compare(senha, this.adminAtual.senha));
      }

      async atualizarAdmin(dados) {
        this.id = this.adminAtual.id;
        this.usuario = dados.usuario;
        if (dados.novaSenha) await this.setSenha(dados.novaSenha);
        return await this.atualizar();
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const form = document.getElementById("formEditarAdmin");
      const mensagem = document.getElementById("mensagem");

      const editar = new EditarAdmin();
      await editar.init();

      // Preencher usuário atual
      document.getElementById("usuarioAtual").value = editar.adminAtual.usuario;

      // Header/Footer
      const caminhoHeader = "/dashboard/_header.html"; 
      const caminhoFooter = "/dashboard/_footer.html";
      try {
        document.getElementById("header").innerHTML = await fetch(caminhoHeader).then(r => r.text());
        document.getElementById("footer").innerHTML = await fetch(caminhoFooter).then(r => r.text());
      } catch (err) {
        console.error("Erro ao carregar header/footer:", err);
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const usuarioAtual = document.getElementById("usuarioAtual").value;
        const senhaAtual = document.getElementById("senhaAtual").value;
        const novaSenha = document.getElementById("novaSenha").value;
        const confirmarSenha = document.getElementById("confirmarSenha").value;

        // Validar nova senha
        if (novaSenha && novaSenha !== confirmarSenha) {
          mensagem.innerHTML = `<div class="alert alert-warning">A nova senha e a confirmação não coincidem</div>`;
          return;
        }

        // Validar usuário e senha atual
        if (usuarioAtual !== editar.adminAtual.usuario) {
          mensagem.innerHTML = `<div class="alert alert-warning">O usuário atual não está correto</div>`;
          return;
        }

        const senhaValida = await editar.validarSenhaAtual(senhaAtual);
        if (!senhaValida) {
          mensagem.innerHTML = `<div class="alert alert-warning">Senha atual incorreta</div>`;
          return;
        }

        // Atualizar
        const sucesso = await editar.atualizarAdmin({ usuario: usuarioAtual, novaSenha });
        if (sucesso) {
          mensagem.innerHTML = `<div class="alert alert-success">Dados atualizados com sucesso!</div>`;
        } else {
          mensagem.innerHTML = `<div class="alert alert-danger">Erro ao atualizar dados</div>`;
        }
      });
    });
  </script>
</body>
</html>
